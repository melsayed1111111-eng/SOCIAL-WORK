<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ø®ÙŠØ±ÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #27ae60; --secondary: #2c3e50; --danger: #e74c3c; --accent: #3498db; --bg: #f0f2f5; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .view { display: none; }
        .view.active { display: block; }

        header { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 25px; padding-bottom: 15px; }
        h2 { color: var(--secondary); margin: 25px 0 15px; border-right: 5px solid var(--primary); padding-right: 10px; font-size: 18px; }

        .login-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 50px; }
        .role-card { background: white; border: 2px solid #eee; padding: 30px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.3s; }
        .role-card:hover { border-color: var(--primary); transform: translateY(-5px); }

        .flex-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        input, select, button, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; font-family: 'Tajawal'; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        
        .btn-logout { background: #666; margin-bottom: 20px; padding: 10px 20px; }
        .btn-del { background: var(--danger); padding: 5px 8px; font-size: 11px; }
        .btn-deliver { background: var(--accent); font-size: 11px; }

        .table-wrapper { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; min-width: 900px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
        th { background-color: var(--secondary); color: white; }
        
        .status-done { color: var(--primary); font-weight: bold; }
        .status-pending { color: var(--danger); font-weight: bold; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; background: #eee; }
    </style>
</head>
<body>

<!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="view-login" class="container view active">
    <header>
        <h1>ğŸ’ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª</h1>
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‡ÙˆÙŠØªÙƒ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
    </header>
    <div class="login-grid">
        <div class="role-card" onclick="checkAdminPass()">
            <span>ğŸ”</span>
            <h3>Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©)</h3>
        </div>
        <div class="role-card">
            <span>ğŸšš</span>
            <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h3>
            <select id="select-officer-login" onchange="enterOfficerDashboard(this.value)">
                <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„...</option>
            </select>
        </div>
    </div>
</div>

<!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… -->
<div id="view-admin" class="container view">
    <button class="btn-logout" onclick="showLogin()">â† Ø®Ø±ÙˆØ¬</button>
    
    <h2>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ ØªÙˆØ²ÙŠØ¹ (Ù…Ù†Ø¯ÙˆØ¨) Ø¬Ø¯ÙŠØ¯</h2>
    <div class="flex-box">
        <input type="text" id="adminName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
        <input type="number" id="adminPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="number" id="adminIDCard" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
        <input type="text" id="adminRegion" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ Ø¹Ù†Ù‡Ø§">
        <button onclick="addOfficial()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ +</button>
    </div>
    
    <div class="table-wrapper">
        <table>
            <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="officialsTableBody"></tbody>
        </table>
    </div>

    <hr>

    <h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙÙŠØ¯ (Ù…Ø­ØªØ§Ø¬) Ø¬Ø¯ÙŠØ¯</h2>
    <div class="flex-box">
        <input type="text" id="benName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
        <input type="number" id="benID" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)">
        <input type="text" id="benAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
        <input type="number" id="benPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="number" id="benFamily" placeholder="Ø¹Ø¯Ø¯ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø±Ø©">
        <select id="benSocial">
            <option value="">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</option>
            <option value="Ø£Ø±Ù…Ù„Ø©">Ø£Ø±Ù…Ù„Ø©</option>
            <option value="Ù…Ø·Ù„Ù‚">Ù…Ø·Ù„Ù‚/Ø©</option>
            <option value="Ù…ØªØ²ÙˆØ¬ ÙˆÙŠØ¹ÙˆÙ„">Ù…ØªØ²ÙˆØ¬ ÙˆÙŠØ¹ÙˆÙ„</option>
            <option value="Ø¹Ø§Ø¬Ø²">Ø¹Ø§Ø¬Ø²/Ù…Ø±Ø¶ÙŠ</option>
            <option value="ØºÙŠØ± Ø°Ù„Ùƒ">ØºÙŠØ± Ø°Ù„Ùƒ</option>
        </select>
        <select id="benOfficialSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</option></select>
        <input type="text" id="benType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©">
        <textarea id="benDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø©" style="grid-column: span 2;"></textarea>
        <button onclick="addBeneficiary()" style="grid-column: span 1;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</button>
    </div>

    <h2>ğŸ“Š ÙƒØ´Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø£Ø³Ø±Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</th><th>Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th><th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
        </table>
    </div>
</div>

<!-- 3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ -->
<div id="view-officer" class="container view">
    <button class="btn-logout" onclick="showLogin()">â† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    <header>
        <h1 id="officer-welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹..</h1>
        <p id="officer-region-subtitle">Ù…Ù†Ø·Ù‚Ø©: ..</p>
    </header>

    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ø§Ù„Ù…Ø®ØµØµÙŠÙ† Ù„Ùƒ</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø£Ø³Ø±Ø©</th><th>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                </tr>
            </thead>
            <tbody id="officerTableBody"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, onSnapshot, updateDoc, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCC_ENWMUsZ9yrowWOKJzxKBfhmkr9YwBs",
        authDomain: "social-work-36aa0.firebaseapp.com",
        projectId: "social-work-36aa0",
        storageBucket: "social-work-36aa0.firebasestorage.app",
        messagingSenderId: "276024514062",
        appId: "1:276024514062:web:bb0c66b4d579692c920e5f",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const benCol = collection(db, "beneficiaries");
    const offCol = collection(db, "officials");

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    window.checkAdminPass = () => {
        const pass = prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±:");
        if(pass === "admin1234") switchView('view-admin');
        else alert("Ø®Ø·Ø£!");
    };

    window.showLogin = () => switchView('view-login');

    window.enterOfficerDashboard = (name) => {
        if(!name) return;
        const opt = document.querySelector(`#select-officer-login option[value="${name}"]`);
        document.getElementById('officer-welcome-title').innerText = `Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${name}`;
        document.getElementById('officer-region-subtitle').innerText = `Ù…Ù†Ø·Ù‚Ø©: ${opt.dataset.region}`;
        loadOfficerData(name);
        switchView('view-officer');
    };

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† ---
    window.addOfficial = async () => {
        const name = document.getElementById('adminName').value;
        const phone = document.getElementById('adminPhone').value;
        const idCard = document.getElementById('adminIDCard').value;
        const region = document.getElementById('adminRegion').value;

        if(!name || !idCard) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨");
        await addDoc(offCol, { name, phone, idCard, region });
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        ['adminName','adminPhone','adminIDCard','adminRegion'].forEach(id => document.getElementById(id).value = '');
    };

    window.deleteOfficial = async (id, name) => {
        if(confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ${name}ØŸ`)) await deleteDoc(doc(db, "officials", id));
    };

    onSnapshot(offCol, (snap) => {
        const table = document.getElementById('officialsTableBody');
        const loginSel = document.getElementById('select-officer-login');
        const adminSel = document.getElementById('benOfficialSelect');
        table.innerHTML = '';
        loginSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„...</option>';
        adminSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</option>';

        snap.forEach(d => {
            const o = d.data();
            table.innerHTML += `<tr><td>${o.name}</td><td>${o.phone}</td><td>${o.idCard}</td><td>${o.region}</td><td><button class="btn-del" onclick="deleteOfficial('${d.id}','${o.name}')">Ø­Ø°Ù</button></td></tr>`;
            const opt = `<option value="${o.name}" data-region="${o.region}">${o.name}</option>`;
            loginSel.innerHTML += opt;
            adminSel.innerHTML += opt;
        });
    });

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† ---
    window.addBeneficiary = async () => {
        const data = {
            name: document.getElementById('benName').value,
            idCard: document.getElementById('benID').value,
            address: document.getElementById('benAddress').value,
            phone: document.getElementById('benPhone').value,
            familyCount: document.getElementById('benFamily').value,
            socialStatus: document.getElementById('benSocial').value,
            official: document.getElementById('benOfficialSelect').value,
            type: document.getElementById('benType').value,
            details: document.getElementById('benDetails').value,
            region: document.getElementById('benOfficialSelect').options[document.getElementById('benOfficialSelect').selectedIndex].dataset.region,
            status: 'pending',
            timestamp: Date.now()
        };

        if(!data.name || !data.idCard || !data.official) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨");

        const q = query(benCol, where("idCard", "==", data.idCard));
        const check = await getDocs(q);
        if(!check.empty) return alert("âš ï¸ ØªÙƒØ±Ø§Ø±! Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!");

        await addDoc(benCol, data);
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­ØªØ§Ø¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        ['benName','benID','benAddress','benPhone','benFamily','benType','benDetails'].forEach(id => document.getElementById(id).value = '');
    };

    onSnapshot(query(benCol, orderBy("timestamp", "desc")), (snap) => {
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '';
        let i = 1;
        snap.forEach(d => {
            const b = d.data();
            tbody.innerHTML += `<tr>
                <td>${i++}</td><td>${b.name}</td><td>${b.idCard}</td><td>${b.address}</td><td>${b.phone}</td><td>${b.familyCount}</td><td>${b.socialStatus}</td>
                <td>${b.official}</td><td>${b.type}</td>
                <td class="${b.status=='done'?'status-done':'status-pending'}">${b.status=='done'?'Ø§Ø³ØªÙ„Ù… âœ…':'Ø§Ù†ØªØ¸Ø§Ø± â³'}</td>
                <td><button onclick="deleteBen('${d.id}')" class="btn-del">Ø­Ø°Ù</button></td>
            </tr>`;
        });
    });

    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ---
    function loadOfficerData(offName) {
        const q = query(benCol, where("official", "==", offName));
        onSnapshot(q, (snap) => {
            const tbody = document.getElementById('officerTableBody');
            tbody.innerHTML = '';
            let i = 1;
            snap.forEach(d => {
                const b = d.data();
                const isDone = b.status == 'done';
                tbody.innerHTML += `<tr>
                    <td>${i++}</td><td><b>${b.name}</b></td><td>${b.address}</td><td>${b.phone}</td><td>${b.familyCount}</td><td>${b.type}</td><td>${b.details}</td>
                    <td class="${isDone?'status-done':'status-pending'}">${isDone?'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…':'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</td>
                    <td>${!isDone ? `<button class="btn-deliver" onclick="markDelivered('${d.id}')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>` : 'ØªÙ…'}</td>
                </tr>`;
            });
        });
    }

    window.markDelivered = async (id) => {
        if(confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŸ")) await updateDoc(doc(db, "beneficiaries", id), { status: 'done' });
    };

    window.deleteBen = async (id) => {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ")) await deleteDoc(doc(db, "beneficiaries", id));
    };

</script>
</body>
</html>