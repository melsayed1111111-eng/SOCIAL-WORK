<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ø®ÙŠØ±ÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¢Ù…Ù†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #27ae60;
            --secondary: #2c3e50;
            --danger: #e74c3c;
            --accent: #3498db;
            --bg: #f0f2f5;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        header {
            text-align: center;
            border-bottom: 3px solid var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
        }

        h2 {
            color: var(--secondary);
            margin: 25px 0 15px;
            border-right: 5px solid var(--primary);
            padding-right: 10px;
            font-size: 20px;
        }

        .login-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 50px;
        }

        .role-card {
            background: white;
            border: 2px solid #eee;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .role-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .flex-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        input,
        select,
        button {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Tajawal';
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.9;
        }

        .btn-logout {
            background: #666;
            margin-bottom: 20px;
        }

        .btn-del {
            background: var(--danger);
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-deliver {
            background: var(--accent);
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--secondary);
            color: white;
        }

        .status-done {
            color: var(--primary);
            font-weight: bold;
        }

        .status-pending {
            color: var(--danger);
            font-weight: bold;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: #eee;
        }
    </style>
</head>

<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡ÙˆÙŠØ© (Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
    <div id="view-login" class="container view active">
        <header>
            <h1>ğŸ’ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‡ÙˆÙŠØªÙƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
        </header>
        <div class="login-grid">
            <div class="role-card" onclick="checkAdminPass()">
                <span>ğŸ”</span>
                <h3>Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©)</h3>
                <p>Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</p>
            </div>
            <div class="role-card">
                <span>ğŸšš</span>
                <h3>Ù…Ø³Ø¤ÙˆÙ„ Ù…Ù†Ø·Ù‚Ø© (Ù…Ù†Ø¯ÙˆØ¨)</h3>
                <select id="select-officer-login" onchange="enterOfficerDashboard(this.value)">
                    <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„...</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… -->
    <div id="view-admin" class="container view">
        <button class="btn-logout" onclick="showLogin()">â† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <header>
            <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h1>
        </header>

        <h2>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† (Ø¥Ø¶Ø§ÙØ© / Ø­Ø°Ù)</h2>
        <div class="flex-box">
            <input type="text" id="adminName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
            <input type="text" id="adminRegion" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
            <button onclick="addOfficial()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ +</button>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† -->
        <table>
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                    <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="officialsTableBody"></tbody>
        </table>

        <hr>

        <h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙÙŠØ¯ Ø¬Ø¯ÙŠØ¯</h2>
        <div class="flex-box">
            <input type="text" id="benName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯">
            <input type="number" id="benID" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
            <select id="benOfficialSelect">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</option>
            </select>
            <input type="text" id="benType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©">
            <button onclick="addBeneficiary()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <h2>ğŸ“Š ÙƒØ´Ù Ø¹Ø§Ù… Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th>
                    <th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                    <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
        </table>
    </div>

    <!-- 3. ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨) -->
    <div id="view-officer" class="container view">
        <button class="btn-logout" onclick="showLogin()">â† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <header>
            <h1 id="officer-welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹..</h1>
            <p id="officer-region-subtitle">Ù…Ù†Ø·Ù‚Ø©: ..</p>
        </header>

        <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ø§Ù„ØªØ§Ø¨Ø¹ÙŠÙ† Ù„Ùƒ</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                </tr>
            </thead>
            <tbody id="officerTableBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, onSnapshot, updateDoc }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCC_ENWMUsZ9yrowWOKJzxKBfhmkr9YwBs",
            authDomain: "social-work-36aa0.firebaseapp.com",
            projectId: "social-work-36aa0",
            storageBucket: "social-work-36aa0.firebasestorage.app",
            messagingSenderId: "276024514062",
            appId: "1:276024514062:web:bb0c66b4d579692c920e5f",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const benCol = collection(db, "beneficiaries");
        const offCol = collection(db, "officials");

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        window.checkAdminPass = () => {
            const pass = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±:");
            if (pass === "admin1234") {
                switchView('view-admin');
            } else {
                alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
            }
        };

        window.showLogin = () => {
            document.getElementById('select-officer-login').value = "";
            switchView('view-login');
        };

        window.enterOfficerDashboard = (name) => {
            if (!name) return;
            const opt = document.querySelector(`#select-officer-login option[value="${name}"]`);
            const region = opt.dataset.region;
            document.getElementById('officer-welcome-title').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø£Ø³ØªØ§Ø°/ ${name}`;
            document.getElementById('officer-region-subtitle').innerText = `Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©: ${region}`;
            loadOfficerData(name);
            switchView('view-officer');
        };

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…) ---
        window.addOfficial = async () => {
            const name = document.getElementById('adminName').value;
            const region = document.getElementById('adminRegion').value;
            if (name && region) {
                await addDoc(offCol, { name, region });
                document.getElementById('adminName').value = '';
                document.getElementById('adminRegion').value = '';
            }
        };

        window.deleteOfficial = async (id, name) => {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ "${name}"ØŸ Ø³ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¤ÙˆÙ„ Ø­Ø§Ù„ÙŠ.`)) {
                await deleteDoc(doc(db, "officials", id));
            }
        };

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        onSnapshot(offCol, (snap) => {
            const adminOffTable = document.getElementById('officialsTableBody');
            const loginSelect = document.getElementById('select-officer-login');
            const adminSelect = document.getElementById('benOfficialSelect');

            adminOffTable.innerHTML = '';
            loginSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„...</option>';
            adminSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„...</option>';

            snap.forEach(d => {
                const data = d.data();
                const id = d.id;

                // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø°Ù ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
                adminOffTable.innerHTML += `<tr>
                <td>${data.name}</td>
                <td>${data.region}</td>
                <td><button class="btn-del" onclick="deleteOfficial('${id}', '${data.name}')">Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ğŸ—‘ï¸</button></td>
            </tr>`;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
                const opt = `<option value="${data.name}" data-region="${data.region}">${data.name} (${data.region})</option>`;
                loginSelect.innerHTML += opt;
                adminSelect.innerHTML += opt;
            });
        });

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† ---
        window.addBeneficiary = async () => {
            const name = document.getElementById('benName').value;
            const idCard = document.getElementById('benID').value;
            const offSelect = document.getElementById('benOfficialSelect');
            const official = offSelect.value;
            const region = offSelect.options[offSelect.selectedIndex].dataset.region;
            const type = document.getElementById('benType').value;

            if (!name || !idCard || !official) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            const q = query(benCol, where("idCard", "==", idCard));
            const check = await getDocs(q);
            if (!check.empty) return alert("âš ï¸ ØªÙƒØ±Ø§Ø±! Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹.");

            await addDoc(benCol, { name, idCard, official, region, type, status: 'pending', timestamp: Date.now() });
            alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯");
            document.getElementById('benName').value = '';
            document.getElementById('benID').value = '';
        };

        onSnapshot(benCol, (snap) => {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            snap.forEach(d => {
                const b = d.data();
                tbody.innerHTML += `<tr>
                <td>${b.name}</td>
                <td>${b.idCard}</td>
                <td>${b.official} <span class="badge">${b.region}</span></td>
                <td class="${b.status == 'done' ? 'status-done' : 'status-pending'}">${b.status == 'done' ? 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</td>
                <td><button onclick="deleteBen('${d.id}')" class="btn-del">Ø­Ø°Ù</button></td>
            </tr>`;
            });
        });

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ---
        function loadOfficerData(officerName) {
            const q = query(benCol, where("official", "==", officerName));
            onSnapshot(q, (snap) => {
                const tbody = document.getElementById('officerTableBody');
                tbody.innerHTML = '';
                snap.forEach(d => {
                    const b = d.data();
                    const isDone = b.status == 'done';
                    tbody.innerHTML += `<tr>
                    <td>${b.name}</td>
                    <td>${b.type}</td>
                    <td class="${isDone ? 'status-done' : 'status-pending'}">${isDone ? 'âœ… ØªÙ…' : 'â³ Ø§Ù†ØªØ·Ø§Ø±'}</td>
                    <td>${!isDone ? `<button class="btn-deliver" onclick="markDelivered('${d.id}')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>` : '---'}</td>
                </tr>`;
                });
            });
        }

        window.markDelivered = async (id) => {
            if (confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…ØŸ")) await updateDoc(doc(db, "beneficiaries", id), { status: 'done' });
        };

        window.deleteBen = async (id) => {
            if (confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ØŸ")) await deleteDoc(doc(db, "beneficiaries", id));
        };

    </script>
</body>

</html>